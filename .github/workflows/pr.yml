name: CI/CD - Pull request

on:
  workflow_run:
    workflows: [CI/CD - Build]
    types:
      - completed

permissions:
    contents: write
    actions: write
    checks: write
    pull-requests: write
    discussions: write
    issues: write

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

jobs:

    lint-linux:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0.

            - name: Restore previous build
              id: github-cache-conan-restore
              uses: actions/cache/restore@v3
              with:
                  path: |
                    ./build
                  key: host-${{ runner.os }}-${{ hashFiles('conanfile.py') }}

            - name: Run linter
              uses: cpp-linter/cpp-linter-action@v2
              id: linter
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                style: file
                files-changed-only: true
                tidy-checks: ''
                extra-args: '-std=c++20 -Wall'
                version: '15'
                database: './build/'
                ignore: 'build | .github'

            - name: Check linting
              continue-on-error: true # Change me to false once we figure out linting
              if: steps.linter.outputs.checks-failed > 0
              run: echo "Linting failed!" | exit 1
